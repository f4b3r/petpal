version: '3'

volumes:
  postgres_data:
    driver: local
  keycloak_data: # Add a new volume for Keycloak
    driver: local
  mysql-data:
    driver: local
    
networks:
  backend:
  frontend:    
  
services:
    #        POSTGRES SERVICE
  postgres:
    image: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password


   #        KEYCLOAK SERVICE
  keycloak:
    image: quay.io/keycloak/keycloak:21.0.1
    volumes:
      - keycloak_data:/opt/jboss/keycloak
    environment:
      DB_VENDOR: POSTGRES
      DB_ADDR: postgres
      DB_DATABASE: keycloak
      DB_USER: keycloak
      DB_SCHEMA: public
      DB_PASSWORD: password
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: Pa55w0rd
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    command: ['start-dev --http-relative-path=/auth']
    ports:
      - 8080:8080
    depends_on:
      - postgres
      
      
    # PETPAL CORE SERVICE
  petpal-core:
    image: petpal-core:1.0.0
    build:
        context: petpal-core
        dockerfile: Dockerfile
    restart: "always"
    networks:
      - backend
      - frontend
    ports:
      - "8081:8080"
      - "5005:5005"
    environment:
      - LOG_LEVEL=DEBUG
      - JAVA_DEBUG=true
      - JAVA_DEBUG_PORT=*:5005
      - JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
      - DB_HOST=mysql_core
      - DB_PORT=3306
      - DB_NAME=petpal
      - DB_USER=petpalcore
      - DB_PWD=petpal
      - DB_SSL=false
    depends_on:
     - mysql_core
    logging:
        driver: local
        options:
            max-size: "20m"
            max-file: "10"
            
            
            
    
    # Database Service (Mysql)
  mysql_core:
    image: mysql
    ports:
      - "3306:3306"
    restart: always
    environment:
      MYSQL_DATABASE: petpal
      MYSQL_USER: petpalcore
      MYSQL_PASSWORD: petpal
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - backend
